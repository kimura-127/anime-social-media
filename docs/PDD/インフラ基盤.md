# インフラ基盤

## 概要
Next.jsを中心とした低コストでスケーラブルな開発スタックについて、参考サイト（https://www.runfunrun.dev/posts/next-stack）の内容をまとめています。

## 技術スタック構成

### フロントエンド・フレームワーク
- **Next.js**
  - フルスタックアプローチでの開発
  - サーバーサイドレンダリング対応
  - API Routesによるバックエンド機能

### インフラストラクチャ
- **Cloudflare Workers**
  - PaaS（Platform as a Service）として使用
  - 低コストでのデプロイメント
  - 収益化を見据えたスケーラブルな構成

### バックエンド・API
- **Hono**
  - API Routes用の軽量フレームワーク
  - 高速なHTTPルーター
  - Hono RPCによる型安全な通信
  - Cloudflare Workersでの最適化

### AIエージェントフレームワーク
- **Mastra**
  - TypeScript製のAIエージェントフレームワーク
  - LLMモデル統合（GPT-4、Claude、Gemini、Llama対応）
  - Honoとの統合によりCloudflare Workersでデプロイ可能
  - 型安全なAIエージェント開発環境

### データベース・ORM
- **Cloudflare D1**
  - SQLiteベースのサーバーレスデータベース
  - Cloudflareエコシステムとの親和性

- **Drizzle ORM**
  - 軽量で高性能なORM
  - TypeScript完全対応
  - 型安全なクエリビルダー

### 認証システム
- **Better Auth**
  - 現代的な認証ライブラリ
  - セキュアな認証フロー

### デプロイメント
- **OpenNext**
  - Vercel以外でのNext.jsデプロイを可能にする
  - 柔軟なデプロイオプション

## このスタックの特徴

### メリット
1. **低コスト運用**
   - 個人開発に適したコスト効率
   - 従量課金による無駄のない料金体系

2. **型安全性**
   - TypeScript完全対応
   - フロントエンドからバックエンドまでの一貫した型安全性

3. **スケーラビリティ**
   - Cloudflare Workersによる高いパフォーマンス
   - 収益化を見据えた拡張性

4. **開発体験**
   - 統一されたNext.jsエコシステム
   - 高速な開発サイクル

### 適用場面
- 個人開発プロジェクト
- MVPの迅速な構築
- 将来的な収益化を考慮したサービス
- 低予算でのサービス運用

## 現在のプロジェクトとの比較検討事項

このスタック構成は、アニメSNSプロジェクトにおいて以下の観点で参考になる可能性があります：

- コスト効率の改善
- インフラストラクチャの簡素化
- 型安全性の向上
- デプロイメント戦略の見直し

実装時には、現在の要件と照らし合わせて適用可能な部分を選択的に取り入れることを検討できます。

## モノレポ構成での実装方針

### アーキテクチャ概要
Hono + Mastra + Cloudflare Workers + Next.jsをモノレポ構成で実装し、各コンポーネントを独立したフォルダに分離する方針を採用します。

### フォルダ構成

```
anime-social-media/
├── apps/
│   ├── web/                    # Next.jsフロントエンド
│   │   ├── app/
│   │   │   ├── actions.ts      # Mastra統合用サーバーアクション
│   │   │   ├── components/
│   │   │   └── api/
│   │   ├── lib/
│   │   │   └── mastra.ts       # Mastraクライアント設定
│   │   └── next.config.js      # transpilePackages設定含む
│   └── api/                    # Mastra AIエージェントサービス
│       └── mastra/
│           ├── agents/         # AIエージェント実装
│           │   └── agents.ts
│           ├── workflows/      # ワークフロー定義
│           ├── tools/          # カスタムツール
│           └── index.ts        # Mastra設定・エントリーポイント
├── packages/
│   ├── shared/                 # 共通型定義・ユーティリティ
│   │   ├── types/
│   │   └── utils/
│   ├── ui/                     # UIコンポーネントライブラリ
│   └── config/                 # 共通設定ファイル
├── tools/
│   └── tsconfig/               # TypeScript共通設定
├── docs/                       # ドキュメント
└── turbo.json                  # Turborepo設定
```

### モノレポ管理ツール
- **Turborepo**を採用
  - 高性能なビルドキャッシュシステム
  - 並列実行によるビルド時間短縮
  - TypeScript最適化
  - 段階的導入が可能

### 各フォルダの役割

#### apps/web（Next.jsフロントエンド）
- ユーザーインターフェース
- Mastraエージェントとの連携（サーバーアクション）
- 静的アセット管理

#### apps/api（Mastra AIエージェント）
- AIエージェントの実装
- Honoサーバーとしてビルド
- Cloudflare Workersでデプロイ
- LLMとの統合処理

#### packages/shared
- 型定義の共通化
- 両アプリケーション間で使用するユーティリティ
- API契約の型安全性確保

### 技術的な利点
1. **独立したスケーリング**：フロントエンドとAIバックエンドを個別に最適化・デプロイ可能
2. **開発効率**：共通コードの再利用と型安全性の確保
3. **チーム開発**：機能別の責任分離によるコラボレーション向上
4. **デプロイメント柔軟性**：各サービスを異なるCloudflare環境にデプロイ可能

### 統合方式
- **サーバーアクション統合**：同一アプリ内でのAIエージェント実行
- **独立サービス統合**：MastraクライアントライブラリによるAPI通信
- **Hono RPC**：型安全なクライアント・サーバー間通信